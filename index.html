<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Учёт отсутствий в Польше — absence-tracker</title>
  <style>
    :root{--bg:#f6f8fa;--card:#fff;--muted:#6b7280;--accent:#2563eb}
    html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, sans-serif;background:var(--bg);color:#111}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:16px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(16,24,40,0.06)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="date"], select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe}
    .row{display:flex;gap:8px;align-items:center}
    .people-list{max-height:320px;overflow:auto;margin-top:8px}
    .person-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px}
    .trips-table{width:100%;border-collapse:collapse;margin-top:8px}
    .trips-table th,.trips-table td{padding:6px;border-bottom:1px solid #f3f4f6;text-align:left;font-size:13px}
    .result-table{width:100%;border-collapse:collapse;margin-top:8px}
    .result-table th,.result-table td{padding:8px;border-bottom:1px solid #f3f4f6;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px}
    .flex{display:flex;gap:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .note{background:#fffbeb;padding:8px;border-radius:8px;border:1px solid #fef3c7;margin-top:8px;color:#7c4b00}
    .danger{background:#fff1f2;padding:8px;border-radius:8px;border:1px solid #fecaca;color:#7f1d1d}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    .pill{background:#eef2ff;padding:4px 8px;border-radius:999px;font-size:12px;color:#3730a3}
    .badge{font-size:12px;color:var(--muted)}
    .trip-actions button{margin-left:6px}
    textarea{width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid #e6e9ef}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;flex-direction:column">
        <h1>Учёт отсутствий в Польше</h1>
        <span class="muted">Добавляйте поездки, указывайте период расчёта — программа посчитает суммарные дни отсутствия.</span>
      </div>
      <div style="margin-left:auto" class="pill">Файл: <strong>index.html</strong></div>
    </header>

    <div class="grid">
      <!-- Left: main controls -->
      <div>
        <div class="card">
          <h3>Параметры периода</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Дата 1 — конечная (date1)</label>
              <input id="date1" type="date" />
            </div>
            <div style="width:220px">
              <label>Дата 2 — начальная (date2)</label>
              <input id="date2" type="date" />
            </div>
          </div>
          <div style="margin-top:8px" class="row">
            <label style="margin:0;flex:1"><input id="includeReturn" type="checkbox" checked /> &nbsp; Считать день возвращения <span class="muted">(если включено — день возврата считается отсутствующим)</span></label>
          </div>

          <div style="margin-top:10px" class="controls">
            <button id="calcAll">Посчитать для всех</button>
            <button id="loadSample" class="ghost">Загрузить пример</button>
            <button id="clearLocal" class="ghost">Очистить localStorage</button>
            <button id="exportJson" class="ghost">Экспорт JSON</button>
            <button id="importJsonBtn" class="ghost">Импорт JSON</button>
          </div>

          <div class="note">Правило подсчёта: поездка — период с даты выезда (включительно) до даты возвращения (обычно возвращение НЕ учитывается, но опция выше может включить).</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Результаты</h3>
          <div id="results"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Детализация поездки</h3>
          <div id="details"></div>
        </div>

      </div>

      <!-- Right: people and trips -->
      <div>
        <div class="card">
          <h3>Люди</h3>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <input id="newPersonName" type="text" placeholder="Имя (напр. Иван Иванов)" />
            <button id="addPerson">Добавить</button>
          </div>
          <div class="people-list" id="peopleList"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Поездки выбранного человека</h3>
          <div id="personHeader" class="muted small">Выберите человека слева</div>

          <div id="tripsArea" style="display:none;margin-top:8px">
            <table class="trips-table" id="tripsTable">
              <thead><tr><th>Выезд</th><th>Въезд</th><th>Заметка</th><th></th></tr></thead>
              <tbody></tbody>
            </table>

            <div style="margin-top:8px">
              <label>Новая поездка</label>
              <div style="display:flex;gap:8px">
                <input id="tripExit" type="date" />
                <input id="tripReturn" type="date" />
              </div>
              <input id="tripNote" type="text" placeholder="Заметка (опционально)" style="margin-top:8px" />
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="addTrip">Добавить поездку</button>
                <button id="mergeTrips" class="ghost">Объединить пересечения</button>
              </div>
            </div>
          </div>
        </div>

        <footer>
          <div class="muted">Данные хранятся в localStorage (ключ <code>absenceData</code>). Экспорт/импорт — JSON.</div>
        </footer>
      </div>
    </div>

    <input id="importJsonFile" type="file" accept="application/json" style="display:none" />
  </div>

<script>
// ------------------ Utility functions ------------------
function uid(prefix='id'){return prefix+'-'+Math.random().toString(36).slice(2,11)}
function parseISO(dateStr){ if(!dateStr) return null; const [y,m,d]=dateStr.split('-').map(Number); return new Date(Date.UTC(y,m-1,d)); }
function isoDate(dt){ if(!dt) return null; if(typeof dt==='string') return dt; const y=dt.getUTCFullYear(); const m=String(dt.getUTCMonth()+1).padStart(2,'0'); const d=String(dt.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${d}` }
function daysBetweenUTC(a,b){ // number of days from date a (inclusive) to date b (exclusive)
  const msPerDay=86400000;
  return Math.round((Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()) - Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate()))/msPerDay);
}

// Merge overlapping or adjacent intervals (array of [startDateObj, endDateObj])
function mergeIntervals(intervals){
  if(!intervals || intervals.length===0) return [];
  // sort by start
  intervals.sort((x,y)=>Date.UTC(x[0].getUTCFullYear(),x[0].getUTCMonth(),x[0].getUTCDate()) - Date.UTC(y[0].getUTCFullYear(),y[0].getUTCMonth(),y[0].getUTCDate()));
  const res=[];
  let [curS,curE]=[intervals[0][0],intervals[0][1]];
  for(let i=1;i<intervals.length;i++){
    const [s,e]=intervals[i];
    // if s <= curE (overlap) or s is exactly curE (adjacent) -> merge
    if(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate()) <= Date.UTC(curE.getUTCFullYear(),curE.getUTCMonth(),curE.getUTCDate())){
      // extend curE to max(curE,e)
      if(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()) > Date.UTC(curE.getUTCFullYear(),curE.getUTCMonth(),curE.getUTCDate())){
        curE = e;
      }
    } else {
      res.push([curS,curE]);
      curS = s; curE = e;
    }
  }
  res.push([curS,curE]);
  return res;
}

// ------------------ Data handling ------------------
const STORAGE_KEY = 'absenceData';
let state = { people: [] };
let selectedPersonId = null;

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); renderPeopleList(); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ try{ state = JSON.parse(raw); }catch(e){ console.error('parse err',e); state={people:[]}; } } else { state={people:[]}; } }

function exportJson(){ const dataStr = JSON.stringify(state,null,2); const blob = new Blob([dataStr],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='absence-data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

function importJson(file){ const reader=new FileReader(); reader.onload = (e)=>{ try{ const parsed = JSON.parse(e.target.result); if(parsed && parsed.people) { state = parsed; saveState(); renderAll(); alert('Импорт завершён'); } else alert('Неправильный формат JSON'); }catch(err){ alert('Ошибка чтения JSON: '+err.message) } };
 reader.readAsText(file);
}

// ------------------ UI rendering ------------------
function formatPersonShort(p){ return p.name + ' (' + (p.trips? p.trips.length:0) + ')' }

function renderPeopleList(){ const container = document.getElementById('peopleList'); container.innerHTML='';
  state.people.forEach(p=>{
    const div=document.createElement('div'); div.className='person-item';
    const left=document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
    const name=document.createElement('div'); name.textContent=p.name; name.style.fontWeight='600';
    const meta=document.createElement('div'); meta.className='muted small'; meta.textContent=(p.trips?p.trips.length:0)+' поездок';
    left.appendChild(name); left.appendChild(meta);
    const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';

    const selectBtn=document.createElement('button'); selectBtn.className='ghost'; selectBtn.textContent='Выбрать'; selectBtn.onclick=()=>{ selectedPersonId=p.id; renderTripsForSelected(); }
    const editBtn=document.createElement('button'); editBtn.className='ghost'; editBtn.textContent='Изменить'; editBtn.onclick=()=>{ const newName=prompt('Новое имя', p.name); if(newName){ p.name=newName; saveState(); }}
    const delBtn=document.createElement('button'); delBtn.className='ghost'; delBtn.textContent='Удалить'; delBtn.onclick=()=>{ if(confirm('Удалить '+p.name+'?')){ state.people = state.people.filter(x=>x.id!==p.id); if(selectedPersonId===p.id) selectedPersonId=null; saveState(); renderAll(); } }

    right.appendChild(selectBtn); right.appendChild(editBtn); right.appendChild(delBtn);

    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);
  });
}

function renderTripsForSelected(){ const header=document.getElementById('personHeader'); const tripsArea=document.getElementById('tripsArea'); const tableBody=document.querySelector('#tripsTable tbody');
  const person = state.people.find(x=>x.id===selectedPersonId);
  if(!person){ tripsArea.style.display='none'; header.textContent='Выберите человека слева'; return; }
  header.textContent = person.name + ' — поездки'; tripsArea.style.display='block'; tableBody.innerHTML='';
  (person.trips || []).forEach(t=>{
    const tr=document.createElement('tr');
    const tdExit=document.createElement('td'); tdExit.textContent = t.exit || '-';
    const tdReturn=document.createElement('td'); tdReturn.textContent = t.return || '-';
    const tdNote=document.createElement('td'); tdNote.textContent = t.note || '';
    const tdAct=document.createElement('td'); tdAct.className='trip-actions';
    const editBtn=document.createElement('button'); editBtn.className='ghost small'; editBtn.textContent='Изм'; editBtn.onclick=()=>{ const newExit=prompt('Дата выезда (YYYY-MM-DD)', t.exit||''); const newReturn=prompt('Дата возвращения (YYYY-MM-DD или пусто)', t.return||''); if(newExit){ t.exit=newExit; t.return=newReturn||null; saveState(); renderTripsForSelected(); } }
    const delBtn=document.createElement('button'); delBtn.className='ghost small'; delBtn.textContent='Del'; delBtn.onclick=()=>{ if(confirm('Удалить поездку?')){ person.trips = person.trips.filter(x=>x.id!==t.id); saveState(); renderTripsForSelected(); } }
    tdAct.appendChild(editBtn); tdAct.appendChild(delBtn);
    tr.appendChild(tdExit); tr.appendChild(tdReturn); tr.appendChild(tdNote); tr.appendChild(tdAct);
    tableBody.appendChild(tr);
  });
}

function renderAll(){ renderPeopleList(); renderTripsForSelected(); render